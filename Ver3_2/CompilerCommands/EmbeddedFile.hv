TryEmbedFile := !(Token^ itm) -> BoxExeObj^
{
	if itm.Down.Right == null or itm.Down.Right.GetValue() != "()"
	{
		itm.EmitError("usage #File(name)")
	}
	skb := itm.Down.Right
	if skb.Down == null or not (skb.Down is TokenString)
	{
		itm.EmitError("usage #File(name)")
	}
	 
	fileName := skb.Down->{TokenString^}.Value

	itFile := FSGetFile(fileName) //todo exceptions?

	if itFile == null
		itm.EmitError("File not found")
	

	emb := EmbFile^
	if not embeddedFiles.Contain(itFile)
	{
		emb = new EmbFile(itFile)
		embeddedFiles[itFile] = emb
	}else{
		emb = embeddedFiles[itFile]
	}

	objs := CheckExeDownList
	objs.Push(emb.data)
	objs.Push(GetExeInt(emb.GetSize()))
	objs.Push(GBoolFalse)
	objs.Push(GetExeString(fileName))

	cnsts := List.{BoxExeConstObj^}

	return CreateFuncCall(StringSpan("internalGetEmbeddedFile"),objs,cnsts)
}



embeddedFiles := AVLMap.{vRepoFile^,EmbFile^} 

BoxRawData := class extend BoxExeObj
{
	Value := u8^
	ValueSize := int

	ItId := int

	this := !(u8^ data, int siz) -> void
	{
		ItId = GetNewId()

		Value = data
		ValueSize = siz

		ObjType = GTypeVoidP

		ValueSize = siz
		if siz != 0
		{
			Value = malloc(siz)->{u8^}
			memcpy(Value,data,siz)
		}
	}
	PrintGlobal := virtual !(Stream^ f) -> void
	{
		f^ << "@File" << ItId << " = global [" << ValueSize << " x i8] ["
		for i : ValueSize
		{
			if i != 0
				f^ << ","
			f^ << "i8 " << Value[i]
		}
		f^ << "]\n"
	}
	PrintPre := virtual !(Stream^ f) -> void
	{
	}
	PrintUse := virtual !(Stream^ f) -> void
	{
		f^ << "getelementptr inbounds ([" << ValueSize << " x i8] , [ " << ValueSize << " x i8]* @File" << ItId <<" , i32 0, i32 0)"
	}

	GetSize := !() -> int
	{
		return ValueSize
	}

}

EmbFile := class
{
	itFile := vRepoFile^
	fileMap := FileView^
	data := BoxRawData^

	this := !(vRepoFile^ inFile) -> void
	{
		itFile = inFile

		fileMap = inFile.GetMap()
		data = new BoxRawData(fileMap.Get(),inFile.Size())
	}
	GetSize := !() -> int 
	{
		return data.GetSize()
	}
	PrintGlobal := !(Stream^ f) -> void
	{
		data.PrintGlobal(f)
	}
}

PrintEmbeddedFiles := !(Stream^ f) -> void
{
	for it : embeddedFiles
	{
		it.PrintGlobal(f)
	}
}
