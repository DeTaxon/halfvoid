
BoxFuncTemplate := class extend BoxExeConstObj
{
	AllFuncs := AVLMap.{Type^,List.{BoxFunc^}}
	FuncConstants := AVLMap.{BoxFunc^,Vector.{BoxExeConstObj^}}
	ItCodeSpace := BoxCodeSpace^


	GetDefaultValuesCount := virtual !() -> int { return 0 }

	GetPriority := virtual !(Vector.{BoxExeObj^} objs, Vector.{BoxExeConstObj^} consts,FuncInputObjects^ iObjs) -> int
	{
		fTyp := ToFuncType(objs,consts)

		if fTyp == null
			return CmpNoExchange
		return CheckPriority(fTyp,objs,consts,iObjs)
	}
	GetFunc := virtual !(Vector.{BoxExeObj^} objs, Vector.{BoxExeConstObj^} consts) -> BoxFunc^
	{
		fTyp := ToFuncType(objs,consts)

		assert(fTyp != null)

		pri := CheckPriority(fTyp,objs,consts,null) //TODO iObjs instead of null

		if pri == CmpNoExchange
		{
			assert(false)
			return null
		}
		return GetFuncByType(fTyp,consts)
	}

	GetFuncByType := virtual !(TypeFunc^ fTyp, Vector.{BoxExeConstObj^} consts) -> BoxFunc^
	{
		if AllFuncs.Contain(fTyp)
		{
			for srchF : AllFuncs[fTyp]
			{
				if IsEqConstants(consts,FuncConstants[srchF])
					return srchF
			}
		}

		newFunc := CreateFunc(fTyp,consts)

		AllFuncs[fTyp].Push(newFunc)

		cns := FuncConstants[newFunc]&
		cns.Push(consts[^])

		return newFunc
	}
	ToFuncType := virtual !(Vector.{BoxExeObj^} objs,Vector.{BoxExeConstObj^} consts) -> TypeFunc^
	{
		tps := MakeVectorOnStack.{Type^,12}()
		refs := MakeVectorOnStack.{bool,12}()

		for ob,i : objs
		{
			tps.Push(ob.GetType())
			isRef := false
			if IsComplexType(tps[i])
				isRef = true
			refs.Push(isRef)

		}

		return GetFuncType(tps, refs,GTypeVoid,false,false)
	}
	CheckPriority := virtual !(TypeFunc^ tp,Vector.{BoxExeObj^} objs,Vector.{BoxExeConstObj^} consts,FuncInputObjects^ iObjs) -> int
	{
		return CmpFuncPriorityAllExchange(tp,objs,GetDefaultValuesCount())
	}
	CreateFunc := virtual !(TypeFunc^ tp, Vector.{BoxExeConstObj^} consts) -> BoxFunc^
	{
		assert(false)
		return null
	}

	IsOneFunc := virtual !() -> bool
	{
		return false
	}
	GetOneFunc := virtual !() -> BoxFunc^
	{
		assert(false)
		return null
	}
	SetName := virtual !(Str name) -> void
	{
	}
	CreateFuncCall := virtual !(Vector.{BoxExeObj^} objs,Vector.{BoxExeConstObj^} consts) -> BoxExeObj^
	{
		return CreateFuncCall(objs,consts,null)
	}
	CreateFuncCall := virtual !(Vector.{BoxExeObj^} objs,Vector.{BoxExeConstObj^} consts,FuncInputObjects^ iObjs) -> BoxExeObj^
	{
		fnc := GetFunc(objs,consts)
		return fnc.CreateCall(objs,iObjs)
	}
	GetHeaderHash := virtual !() -> u32
	{
	}
	GetFullHash := virtual !() -> u32
	{
	}
}
