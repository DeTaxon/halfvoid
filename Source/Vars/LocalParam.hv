FuncLocalParam := class extend ParamFunc
{
	CreatedVarCalls := List.{ParamLoadObj^}
	CapturedIndex := int

	RezeroCall := BoxExeObj^

	this := !(Type^ tp) -> void
	{
		assert(CurrentFunc != null)
		parentFunc = CurrentFunc
		irName = GetLVarName(GetNewId())
		SetType(GetFuncType(0,null,null,tp,true,false))

		if tp is TypeClass
		{
			cls := tp->{TypeClass^}.ToClass
			cls.AwaitVTableStep()
			//if cls.VTable.Size() != 0
			//{
				dwns := CheckExeDownList
				fCall := this.CreateCall() //todo exception call?
				dwns.Push(fCall)
				cnsts := List.{BoxExeConstObj^}
				fnc := TemplateInternalInitClass.GetFunc(dwns,cnsts)
				Inits.Push(fnc.CreateCall(dwns))
			//}
		}
	}
	IsMem := virtual !() -> bool
	{
		return true
	}

	NotifyCaptureUse := virtual !() -> void
	{
		this&->SetType(FuncLocalParamCaptured)
		this&->{FuncLocalParamCaptured^}.DoCapture()
		assert(this& is FuncLocalParamCaptured)
	}
	PrintCode := virtual !(LLVMWriteContext^ ctx) -> void
	{
		PrintMakeZero(ctx)
		Inits[^].PrintDefaultUse(ctx)
	}

	PrintAlloc := virtual !(LLVMWriteContext^ ctx) -> void
	{
		pType := GetType()->{TypeFunc^}.ResultType
		f := ctx.writeStream

		f^ << irName << " = alloca "
		pType.PrintType(ctx)
		if DebugMode
			f^ << ", !dbg !" << GDebugLineCallId
		f^ << "\n"
	}
	PrintResultObj := virtual !(LLVMWriteContext^ ctx, int resId, int debId) -> void
	{
		ctx.writeStream^ << irName 
	}
	PrintDebugMeta := virtual !(LLVMWriteContext^ ctx) -> void
	{
	}
	PrintFuncCall := virtual !(LLVMWriteContext^ ctx,int resId,int debId,ExeDownList lst) -> void
	{
	}

	populated := bool
	CreateCall := virtual !(CheckExeDownList objs) -> BoxExeObj^
	{
		assert(objs.Size() == 0)
		//assert(not populated)

		if populated
		{
			if this& is FuncLocalParam
			{
				return new BoxFuncCall(this&)
			}else{
				assert(false)
			}
		}

		res := new ParamLoadObj(this&)
		CreatedVarCalls.Push(res)
		return res 
	}

	PopulateCalls := virtual !() -> void
	{
		populated = true
		for it : CreatedVarCalls
		{
			it.CallObj = new BoxFuncCall(this&)
		}
	}
	IsDebuggable := virtual !() -> bool
	{
		return true
	}
	PrintDebugLine := virtual !(LLVMWriteContext^ ctx) -> void
	{
		ctx.writeStream^ << irName
	}
	
}

FuncLocalParamCaptured := class extend FuncLocalParam
{
	NotifyMemUse := virtual !() -> void
	{
	}

	NotifyCaptureUse := virtual !() -> void
	{
	}
	DoCapture := !() -> void
	{
		assert(parentFunc != null)
		CapturedIndex = parentFunc.CapturedVars.Size()
		parentFunc.CapturedVars.Push(this&)

		objs := CheckExeDownList
		objs.Push(this.CreateCall())
		cnsts := List.{BoxExeConstObj^}

		callFunc := GZeroMemTemplate.GetFunc(objs,cnsts)
		assert(callFunc != null)
		RezeroCall = callFunc.CreateCall(objs)

	}
	PrintCode := virtual !(LLVMWriteContext^ ctx) -> void
	{
		RezeroCall?.PrintDefaultUse(ctx)
	}

	GetTupleVar := virtual !() -> BoxExeObj^
	{
		return new BoxFuncCall(parentFunc.CapturedVarsTuple)
	}


	PopulateCalls := virtual !() -> void
	{
		populated = true
		for it : CreatedVarCalls
		{
			getCall := GetTupleVar()
			callType := getCall.GetType()
			cls := BoxClass^
			if callType is in TypeClass
			{
				cls = callType->{TypeClass^}.ToClass
			}else{
				if callType is in TypePoint and callType.Base is in TypeClass
				{
					cls = callType.Base->{TypeClass^}.ToClass
				}
			}
			assert(cls != null)
			fld := cls.GetFieldByIndex(CapturedIndex)
			objs := CheckExeDownList
			objs.Push(getCall)
			assert(fld != null)
			it.CallObj = new BoxFuncCall(fld,objs)
			objs.Destroy()
		}
	}

	IsDebuggable := virtual !() -> bool
	{
		return true
	}

	PrintAlloc := virtual !(LLVMWriteContext^ ctx) -> void
	{
	}
}


GetLVarName := !(int x) -> StringSpan
{
	buff := char[100]
	sprintf(buff[0]&,"%%Var%i",x)
	result = GetConstString(buff[0]&)
}

