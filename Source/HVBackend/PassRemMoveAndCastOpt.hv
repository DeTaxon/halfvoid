

PassRemMoveAndCastOpt := !(MCFunction^ fnc) ->MCFunction^
{
	@once RetConstFuncTableInit()

	tbl := ref RetConstFuncTable

	ctx := MakeGreedyPass(fnc,1,2,true)

	oPtr := ctx.oPtr
	cPtr := ctx.cPtr

	o := ref ctx.objsSize
	c := ref ctx.cmdsSize

	iPtr := fnc.Lines.GetPointer()
	usages := Vector.{int}
	usages.Resize(fnc.Objects.Size())

	for i : fnc.Lines.Size()
	{
		for j : 5
		{
			ob := iPtr[i].var1&[j]
			if ob < usages.Size()
				usages[ob] += 1
		}
	}

	lSize := fnc.Lines.Size()
	i := 0
	while i < lSize
	{
		line := iPtr[i]

		twoAvail := i + 1 < lSize

		if line.opcode == "mov" and c > 0 and usages[line.var2] == 2
			and tbl.Contain(cPtr[c-1].opcode) and cPtr[c-1].var1 == line.var2
		{
			cPtr[c-1].var1 = line.var1
		}else{
			cPtr[c++] = line
		}

		i += 1
	}

	return ctx.GenerateFunc()
}
