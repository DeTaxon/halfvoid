



GCAllocator := class extends IAllocator
{

	pages32 := Allc128.{32}
	pages64 := Allc128.{64}
	pages128 := Allc128.{128}


	memMedium := AllocatorGCMedium

	currentGeneration := u8
	gcThread := BasicThread
	quit := bool

	AllocMem := virtual !(int size, bool dirty = false) -> void^
	{
		size = AlignUp16(size)

		if size <= 32
			return pages32.AllocMem()
		if size <= 64
			return pages64.AllocMem()
		if size <= 128
			return pages128.AllocMem()

		return memMedium.AllocMem(size,dirty)
	}

	FreeMem := virtual !(void^ mem) -> void
	{

	}

	GetMemInfo := !(void^ mem) -> GC2MemInfo
	{
		{
			c := pages32.GetMemInfo(mem)
			if c.IsFound
			{
				result.IsFound = true
				result.OriginalPointer = c.OriginalPointer
				result.GenerationPointer = c.GenerationPointer
				result.MemSize = c.MemSize
				return void
			}
		}
		{
			c := pages64.GetMemInfo(mem)
			if c.IsFound
			{
				result.IsFound = true
				result.OriginalPointer = c.OriginalPointer
				result.GenerationPointer = c.GenerationPointer
				result.MemSize = c.MemSize
				return void
			}
		}
		{
			c := pages128.GetMemInfo(mem)
			if c.IsFound
			{
				result.IsFound = true
				result.OriginalPointer = c.OriginalPointer
				result.GenerationPointer = c.GenerationPointer
				result.MemSize = c.MemSize
				return void
			}
		}

		{
			c := memMedium.GetMemInfo(mem)
			if c.IsFound
			{
				result.IsFound = true
				result.OriginalPointer = c.OriginalPointer
				result.GenerationPointer = c.GenerationPointer
				result.MemSize = c.MemSize
				return void
			}
		}
	}


	GetPointerInfo := !(void^ ptr) -> void
	{
		// actual pointer
		// typeid
		//
	}

	StartGCThread := !() -> void
	{
		gcThread.Start(_callGC2Loop,this&)
	}
	threadLoop := !() -> void
	{
		while not quit
		{
			if MainTask == null
				continue

			currentGeneration += 1

			inf := MainTask.GetStackUsage()

			checkRootRange(inf.StackPointer,inf.TotalSize)

			checkGlobals()
		}
	}

	checkGlobals := !() -> void
	{
		for it : $GlobalVariables
		{
			checkRootRange(it&,it->TypeSize)
		}
	}

	checkRootRange := !(void^ inPtr, size_t size) -> void
	{
		ptr := inPtr->{void^^}
		size = size div 8

		for i : size
		{
			memInf := this.GetMemInfo(ptr[i])

			if memInf.IsFound
			{
				// memInfo.GenerationPointer^ = currentGeneration
			}

		}
	}
}

_callGC2Loop := !(void^ data) -> void
{
	data->{GCAllocator^}.threadLoop()
}

GC2MemInfo := class
{
	IsFound := bool

	OriginalPointer := void^
	GenerationPointer := u8^
	MemSize := int
}
