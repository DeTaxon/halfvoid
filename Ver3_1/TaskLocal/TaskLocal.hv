TaskLocalVar := class extend NamedVar
{
    itType := Type^
    itIndex := int
    this := !(StringSpan name,Type^ tp) -> void
    {
        Name = name
        itType = tp
        itIndex = TaskLocalTypes.Size()
        TaskLocalTypes.Push(tp)
    }
    CreateCall := virtual !() -> BoxExeObj^
    {
        TaskLocalHatch.Await()
        getVar := getTaskVarFunc.CreateCall()
        getVarTypes := GetExchange(getVar,tupleVarType.ItType.GetPoint())

        funcObj := tupleVarType.GetFieldByIndex(itIndex)

        objs := CheckExeDownList
        objs.Push(getVarTypes)
		return funcObj.CreateCall(objs)
    }
}
TaskLocalVarDelayed := class extend NamedVar
{
    itType := Type^
    itIndex := int
	itHatch := THatch
	itToken := Token^
    this := !(StringSpan name,Token^ tp) -> void
    {
        Name = name
		itToken = tp

		SubWork(() ==> {
			itType = ParseType(itToken)
			itIndex = TaskLocalTypes.Size()
			TaskLocalTypes.Push(itType)
			itHatch.Emit()
		})
    }

	PrintCode := virtual !(TIOStream^ f) -> void
	{
	}
    CreateCall := virtual !() -> BoxExeObj^
    {
		itHatch.Await()
        TaskLocalHatch.Await()
        getVar := getTaskVarFunc.CreateCall()
        getVarTypes := GetExchange(getVar,tupleVarType.ItType.GetPoint())

        funcObj := tupleVarType.GetFieldByIndex(itIndex)

        objs := CheckExeDownList
        objs.Push(getVarTypes)
		return funcObj.CreateCall(objs)
    }
}


getTaskVarFunc := BoxFunc^
tupleVarType := BoxClassTupleDelayed^

TaskLocalHatch := THatch

TaskLocalTypes := List.{Type^}

PreInitTaskLocal := !() -> void
{
    tupleVarType = new BoxClassTupleDelayed()

    AllClasses.Push(tupleVarType)

	bSpace := CodeSpaces[-1]&

    varName := StringSpan("internalHVTaskLocalTuple")
    bSpace.Globals[varName].Push(new TypeVar(varName,tupleVarType.ItType))
}

InitTaskLocal := !() -> void
{
    getTaskVarFunc = intGetFunc("internalHVGetTaskLocalTuple")
    //tupleVarType = GetTuple(TaskLocalTypes)
    tupleVarType.InitTuple(TaskLocalTypes)
    TaskLocalHatch.Emit()
}

BoxClassTupleDelayed := class extend BoxClass
{
    this := !() -> void
	{
		ItName = "anon" //todo
		ItId = GetNewId()
		ItType = new TypeClass(this&)
	}
    InitTuple := !(List.{Type^} types) -> void
    {
		for it,i : types //todo remove i
		{
			Fields.Push(new FieldParam(StringSpan(""),types[i]))
		}
		InheritStep()
    }
}
