GlobalVarDelayed := class extend GlobalVar
{
	downToken := Token^

	awaitHatch := THatch

	this := !(StringSpan sn,Token^ tkn) -> void
	{	
		Name = sn
		downToken = tkn

		c := this&
		SubWork(() ==> [c] {
			c.CheckVal()
		})
	}
	CheckVal := !() -> void
	{
		GParsedAllFiles.Await()

		typeToken := downToken
		isThreadLocal := false
		if downToken.GetValue() == "thread_local"
		{
			typeToken = downToken.Right
		}
		if downToken.GetValue() == "task_local"
		{
			assert(false)
		}

		tp := ParseType(typeToken)

		if tp != null
		{
			Value = new GlobalVarFunc(Name,tp)
			if isThreadLocal
				Value->SetType(ThreadLocalVarFunc)
		}else{
			downToken.EmitError("Can not get type of global variable")
		}

		awaitHatch.Emit()
	}
	AwaitType := virtual !() -> void
	{
		awaitHatch.Await()
	}
	Work := virtual !() -> void
	{

	}
}
