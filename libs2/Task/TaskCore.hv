

EnterTaskThreadCycle := !(bool isMainThread) -> void
{

	while true
	{
		ct := CurrentThread

		if ct.DeleteTasks.Size() != 0
		{
			delTask := ct.DeleteTasks.Pop()
			ct.AllTasks.Remove(delTask)
			delTask.Destroy()
			delTask = null
			continue
		}
		
		if ct.PendingTasks.Size() != 0
		{
			ct.itMutex.Lock()
			hm := ct.PendingTasks.Pop()
			ct.itMutex.Unlock()
			hm.switchToTask()
			continue
		}

		if ct.CreateTasks.Size() != 0
		{
			hm := ct.CreateTasks.Pop()
			hm.CreateStack()
			hm.switchToTask()
			continue
		}

		if not isMainThread
		{
			if TaskWorkersToDo.Size() != 0
			{
				hm := TaskWorkersToDo.Pop()
				hm.CreateStack()
				ct.AllTasks.Insert(hm)
				hm.switchToTask()
				continue
			}
		}

		iAmOnUV := false
		TaskCheckMutex.Lock()
		if uvInProgressCount != 0 and not someoneOnUV
		{
			someoneOnUV = true
			iAmOnUV = true
		}else{
			TaskPausedWorkers += 1
			if TaskPausedWorkers == TaskAdditionalWorkers.Size() + 1
			{
				cntr := TaskMainTaskWorker.AllTasks.Size()
				for it : TaskAdditionalWorkers
				{
					cntr += it.AllTasks.Size()
				}
				if cntr == 0
					TaskQuitProgram = true
				TaskWaitTasksConVar.NotifyAll()
			}else{
				TaskWaitTasksConVar.Wait(TaskCheckMutex)
			}
			TaskPausedWorkers -= 1
		}
		TaskCheckMutex.Unlock()

		if iAmOnUV
		{
			TaskUVRunOnce()
			TaskCheckMutex.Lock()
			someoneOnUV = false
			TaskCheckMutex.Unlock()
		}

		if TaskQuitProgram
			break
	}

	if isMainThread
	{
		for it : TaskAdditionalWorkers
		{
			it.itThread.Join()
		}
	}
}
someoneOnUV := bool
